<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Transfer Tokens - Wormhole xDapp Development Book v0.1.0</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../../introduction/introduction.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Overview</li><li class="chapter-item expanded "><a href="../../../dapps/0_xdappOverview.html"><strong aria-hidden="true">1.</strong> xDapps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../dapps/1_defiBasics.html"><strong aria-hidden="true">1.1.</strong> Dapp Ecosystem Basics</a></li><li class="chapter-item expanded "><a href="../../../dapps/2_crossChainInteroperability.html"><strong aria-hidden="true">1.2.</strong> Cross-Chain Interoperability</a></li><li class="chapter-item expanded "><a href="../../../dapps/3_xdataxassets.html"><strong aria-hidden="true">1.3.</strong> xData &amp; xAssets</a></li><li class="chapter-item expanded "><a href="../../../dapps/4_whatIsanXdapp.html"><strong aria-hidden="true">1.4.</strong> What is an xDapp?</a></li><li class="chapter-item expanded "><a href="../../../dapps/5_advantages.html"><strong aria-hidden="true">1.5.</strong> Advantages of xDapps</a></li></ol></li><li class="chapter-item expanded "><a href="../../../wormhole/0_wormholeOverview.html"><strong aria-hidden="true">2.</strong> Wormhole</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../wormhole/1_whatIsWormhole.html"><strong aria-hidden="true">2.1.</strong> What is Wormhole?</a></li><li class="chapter-item expanded "><a href="../../../wormhole/2_architectureOverview.html"><strong aria-hidden="true">2.2.</strong> Architecture Overview</a></li><li class="chapter-item expanded "><a href="../../../wormhole/3_coreLayerContracts.html"><strong aria-hidden="true">2.3.</strong> Core Layer Contracts</a></li><li class="chapter-item expanded "><a href="../../../wormhole/4_vaa.html"><strong aria-hidden="true">2.4.</strong> VAA: Verified Action Approval</a></li><li class="chapter-item expanded "><a href="../../../wormhole/5_guardianNetwork.html"><strong aria-hidden="true">2.5.</strong> Guardian Network</a></li><li class="chapter-item expanded "><a href="../../../wormhole/6_relayers.html"><strong aria-hidden="true">2.6.</strong> Relayers</a></li><li class="chapter-item expanded "><a href="../../../wormhole/7_portalTokenBridge.html"><strong aria-hidden="true">2.7.</strong> Portal xAsset Bridge</a></li><li class="chapter-item expanded "><a href="../../../wormhole/8_wormchain.html"><strong aria-hidden="true">2.8.</strong> Wormchain</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">xDapp Development</li><li class="chapter-item expanded "><a href="../../../development/overview.html"><strong aria-hidden="true">3.</strong> Before You Start</a></li><li class="chapter-item expanded "><a href="../../../development/wormhole-local-validator.html"><strong aria-hidden="true">4.</strong> Wormhole Local Validator</a></li><li class="chapter-item expanded "><a href="../../../development/tilt/overview.html"><strong aria-hidden="true">5.</strong> Tilt Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/tilt/mac.html"><strong aria-hidden="true">5.1.</strong> MacOS</a></li><li class="chapter-item expanded "><a href="../../../development/tilt/linux.html"><strong aria-hidden="true">5.2.</strong> Linux</a></li><li class="chapter-item expanded "><a href="../../../development/tilt/constants.html"><strong aria-hidden="true">5.3.</strong> Constants</a></li></ol></li><li class="chapter-item expanded "><a href="../../../development/scaffold/overview.html"><strong aria-hidden="true">6.</strong> Project Scaffold</a></li><li class="chapter-item expanded "><a href="../../../development/messages/sending/overview.html"><strong aria-hidden="true">7.</strong> Sending Messages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/messages/sending/evm.html"><strong aria-hidden="true">7.1.</strong> EVM</a></li></ol></li><li class="chapter-item expanded "><a href="../../../development/messages/registration/overview.html"><strong aria-hidden="true">8.</strong> Registering xDapps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/messages/registration/evm.html"><strong aria-hidden="true">8.1.</strong> EVM</a></li></ol></li><li class="chapter-item expanded "><a href="../../../development/messages/relaying/overview.html"><strong aria-hidden="true">9.</strong> Relaying Messages</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">9.1.</strong> Manual Relays</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.2.</strong> REST &amp; Spy Relayer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.3.</strong> Generic Relayers</div></li></ol></li><li class="chapter-item expanded "><a href="../../../development/messages/receiving/overview.html"><strong aria-hidden="true">10.</strong> Receving Messages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/messages/receiving/evm.html"><strong aria-hidden="true">10.1.</strong> EVM</a></li></ol></li><li class="chapter-item expanded "><a href="../../../projects/summary.html"><strong aria-hidden="true">11.</strong> Projects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../projects/evm-messenger/overview.html"><strong aria-hidden="true">11.1.</strong> EVM Messenger</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../projects/evm-messenger/messenger.html"><strong aria-hidden="true">11.1.1.</strong> Solidity</a></li><li class="chapter-item expanded "><a href="../../../projects/evm-messenger/client.html"><strong aria-hidden="true">11.1.2.</strong> JS Client</a></li></ol></li><li class="chapter-item expanded "><a href="../../../projects/messenger/introduction.html"><strong aria-hidden="true">11.2.</strong> Messenger</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">11.2.1.</strong> Prerequistes</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">11.2.1.1.</strong> EVM</div></li><li class="spacer"></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Portal Token Bridge</li><li class="chapter-item expanded "><a href="../../../development/portal/overview.html"><strong aria-hidden="true">12.</strong> Portal</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">12.1.</strong> EVM</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../development/portal/evm/attestingToken.html"><strong aria-hidden="true">12.1.1.</strong> Attesting</a></li><li class="chapter-item expanded "><a href="../../../development/portal/evm/tokenTransfer.html" class="active"><strong aria-hidden="true">12.1.2.</strong> Transfer Tokens</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.</strong> Portal JS Client Transfers</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.1.</strong> EVM to Solana Transfer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.2.</strong> Polygon to Oasis with Relayers</div></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> Portal Payloads</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Other Resources</li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> Reference</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../reference/tools.html"><strong aria-hidden="true">14.1.</strong> Tools</a></li><li class="chapter-item expanded "><a href="../../../reference/github.html"><strong aria-hidden="true">14.2.</strong> Github &amp; Useful Links</a></li><li class="chapter-item expanded "><a href="../../../reference/contracts.html"><strong aria-hidden="true">14.3.</strong> Deployed Contracts</a></li><li class="chapter-item expanded "><a href="../../../reference/rpcnodes.html"><strong aria-hidden="true">14.4.</strong> RPC Nodes</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Wormhole xDapp Development Book v0.1.0</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/certusone/xdapp-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="evm-transferring-a-token"><a class="header" href="#evm-transferring-a-token">EVM: Transferring a Token</a></h1>
<p>WARNING: To be able to successfully transfer a token from Chain A to Chain B, make sure you <a href="./attestingToken.html">attest</a> it first. Otherwise the Token may be transferred, but you won't be able to claim it til it's attested.</p>
<p>One big gotcha new EVM developers usually run into when working with ERC20 tokens is that because EVM uses unsigned integers, there's no concept of decimals. Therefore, tokens usually have up to 18 zeros behind them to denote up to 18 decimal places. Wormhole normalizes this to <em>eight</em> zeros, with transfer amounts rounded down to the nearest 8the decimal. </p>
<p>To wrap the Token Bridge functions in your contract, you can use the Token Bridge interfaces provided under <a href="https://github.com/certusone/xdapp-book/tree/main/projects/evm-tokenbridge/chains/evm/src/Wormhole"><code>projects/evm-tokenbridge/chains/evm/src/Wormhole</code></a> folder of the xDapp Book repository.</p>
<pre><code class="language-solidity">//SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import &quot;@openzeppelin/contracts/token/ERC20/presets/ERC20PresetMinterPauser.sol&quot;;
import &quot;./Wormhole/ITokenBridge.sol&quot;;
import &quot;./Wormhole/PortalWrappedToken.sol&quot;;

contract Treasury {

    address private token_bridge_address = address(0x0290FB167208Af455bB137780163b7B7a9a10C16);
    ITokenBridge token_bridge = ITokenBridge(token_bridge_address);
    address private TKN_address = address(0x2D8BE6BF0baA74e0A907016679CaE9190e80dD0A); 
    ERC20PresetMinterPauser TKN = ERC20PresetMinterPauser(TKN_address);

    uint32 nonce = 0;

    function bridgeToken(uint256 amt, uint16 receipientChainId, bytes32 recipient) public returns (uint64 sequence) {
        nonce += 1;
        return token_bridge.transferTokens(TKN_address, amt, receipientChainId, recipient, 0, nonce);
    }   

    function approveTokenBridge(uint256 amt) public returns (bool) {
        return TKN.approve(token_bridge_address, amt);
    }
}

</code></pre>
<p>To transfer a token, first we have to <em>approve</em> the Token Bridge to be able to spend that Token on our behalf (so it can transfer tokens form our contract to tself). Make sure the <code>bridgeAmt</code> properly takes into account decimals for the ERC20 token.</p>
<pre><code class="language-js">// Here we are approving and transfering 50 tokens. The ERC20 token we are transfering has 18 decimal places.
const bridgeAmt = ethers.utils.parseUnits(&quot;50&quot;, &quot;18&quot;);

await treasury.approveTokenBridge(bridgeAmt, {
    gasLimit: 2000000,
});

</code></pre>
<p>Then we simply call <code>transfer</code> to create the transfer VAA and fetch it from the guardians when it's ready. Note that the target receipient is a Wormhole normalized hex address left-padded to 32 bytes. </p>
<pre><code class="language-js">const targetRecepient = Buffer.from(tryNativeToHexString(targetDeployment.deployedAddress, &quot;ethereum&quot;), 'hex');

const tx = await (await treasury.bridgeToken(
    bridgeAmt,
    targetNetwork.wormholeChainId,
    targetRecepient
)).wait();
const emitterAddr = getEmitterAddressEth(network.tokenBridgeAddress);
const seq = parseSequenceFromLogEth(tx, network.bridgeAddress);
const vaaURL =  `${config.wormhole.restAddress}/v1/signed_vaa/${network.wormholeChainId}/${emitterAddr}/${seq}`;
let vaaBytes = await (await fetch(vaaURL)).json();
while(!vaaBytes.vaaBytes){
    console.log(&quot;VAA not found, retrying in 5s!&quot;);
    await new Promise((r) =&gt; setTimeout(r, 5000)); //Timeout to let Guardiand pick up log and have VAA ready
    vaaBytes = await (await fetch(vaaURL)).json();
}

</code></pre>
<p>After we've fetched the VAA, we can call the <code>completeTransfer()</code> function on the target chain if it's an EVM.</p>
<pre><code class="language-js">
const completeTransferTx = await targetTokenBridge.completeTransfer(Buffer.from(vaaBytes.vaaBytes, &quot;base64&quot;));

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../development/portal/evm/attestingToken.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../../reference/tools.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../development/portal/evm/attestingToken.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../../reference/tools.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
