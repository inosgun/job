<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Solidity - Wormhole xDapp Development Book v0.1.0</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../introduction/introduction.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Overview</li><li class="chapter-item expanded "><a href="../../dapps/0_xdappOverview.html"><strong aria-hidden="true">1.</strong> xDapps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../dapps/1_defiBasics.html"><strong aria-hidden="true">1.1.</strong> Dapp Ecosystem Basics</a></li><li class="chapter-item expanded "><a href="../../dapps/2_crossChainInteroperability.html"><strong aria-hidden="true">1.2.</strong> Cross-Chain Interoperability</a></li><li class="chapter-item expanded "><a href="../../dapps/3_xdataxassets.html"><strong aria-hidden="true">1.3.</strong> xData &amp; xAssets</a></li><li class="chapter-item expanded "><a href="../../dapps/4_whatIsanXdapp.html"><strong aria-hidden="true">1.4.</strong> What is an xDapp?</a></li><li class="chapter-item expanded "><a href="../../dapps/5_advantages.html"><strong aria-hidden="true">1.5.</strong> Advantages of xDapps</a></li></ol></li><li class="chapter-item expanded "><a href="../../wormhole/0_wormholeOverview.html"><strong aria-hidden="true">2.</strong> Wormhole</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../wormhole/1_whatIsWormhole.html"><strong aria-hidden="true">2.1.</strong> What is Wormhole?</a></li><li class="chapter-item expanded "><a href="../../wormhole/2_architectureOverview.html"><strong aria-hidden="true">2.2.</strong> Architecture Overview</a></li><li class="chapter-item expanded "><a href="../../wormhole/3_coreLayerContracts.html"><strong aria-hidden="true">2.3.</strong> Core Layer Contracts</a></li><li class="chapter-item expanded "><a href="../../wormhole/4_vaa.html"><strong aria-hidden="true">2.4.</strong> VAA: Verified Action Approval</a></li><li class="chapter-item expanded "><a href="../../wormhole/5_guardianNetwork.html"><strong aria-hidden="true">2.5.</strong> Guardian Network</a></li><li class="chapter-item expanded "><a href="../../wormhole/6_relayers.html"><strong aria-hidden="true">2.6.</strong> Relayers</a></li><li class="chapter-item expanded "><a href="../../wormhole/7_portalTokenBridge.html"><strong aria-hidden="true">2.7.</strong> Portal xAsset Bridge</a></li><li class="chapter-item expanded "><a href="../../wormhole/8_wormchain.html"><strong aria-hidden="true">2.8.</strong> Wormchain</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">xDapp Development</li><li class="chapter-item expanded "><a href="../../development/overview.html"><strong aria-hidden="true">3.</strong> Before You Start</a></li><li class="chapter-item expanded "><a href="../../development/wormhole-local-validator.html"><strong aria-hidden="true">4.</strong> Wormhole Local Validator</a></li><li class="chapter-item expanded "><a href="../../development/tilt/overview.html"><strong aria-hidden="true">5.</strong> Tilt Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development/tilt/mac.html"><strong aria-hidden="true">5.1.</strong> MacOS</a></li><li class="chapter-item expanded "><a href="../../development/tilt/linux.html"><strong aria-hidden="true">5.2.</strong> Linux</a></li><li class="chapter-item expanded "><a href="../../development/tilt/constants.html"><strong aria-hidden="true">5.3.</strong> Constants</a></li></ol></li><li class="chapter-item expanded "><a href="../../development/scaffold/overview.html"><strong aria-hidden="true">6.</strong> Project Scaffold</a></li><li class="chapter-item expanded "><a href="../../development/messages/sending/overview.html"><strong aria-hidden="true">7.</strong> Sending Messages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development/messages/sending/evm.html"><strong aria-hidden="true">7.1.</strong> EVM</a></li></ol></li><li class="chapter-item expanded "><a href="../../development/messages/registration/overview.html"><strong aria-hidden="true">8.</strong> Registering xDapps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development/messages/registration/evm.html"><strong aria-hidden="true">8.1.</strong> EVM</a></li></ol></li><li class="chapter-item expanded "><a href="../../development/messages/relaying/overview.html"><strong aria-hidden="true">9.</strong> Relaying Messages</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">9.1.</strong> Manual Relays</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.2.</strong> REST &amp; Spy Relayer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.3.</strong> Generic Relayers</div></li></ol></li><li class="chapter-item expanded "><a href="../../development/messages/receiving/overview.html"><strong aria-hidden="true">10.</strong> Receving Messages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development/messages/receiving/evm.html"><strong aria-hidden="true">10.1.</strong> EVM</a></li></ol></li><li class="chapter-item expanded "><a href="../../projects/summary.html"><strong aria-hidden="true">11.</strong> Projects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../projects/evm-messenger/overview.html"><strong aria-hidden="true">11.1.</strong> EVM Messenger</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../projects/evm-messenger/messenger.html" class="active"><strong aria-hidden="true">11.1.1.</strong> Solidity</a></li><li class="chapter-item expanded "><a href="../../projects/evm-messenger/client.html"><strong aria-hidden="true">11.1.2.</strong> JS Client</a></li></ol></li><li class="chapter-item expanded "><a href="../../projects/messenger/introduction.html"><strong aria-hidden="true">11.2.</strong> Messenger</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">11.2.1.</strong> Prerequistes</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">11.2.1.1.</strong> EVM</div></li><li class="spacer"></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Portal Token Bridge</li><li class="chapter-item expanded "><a href="../../development/portal/overview.html"><strong aria-hidden="true">12.</strong> Portal</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">12.1.</strong> EVM</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development/portal/evm/attestingToken.html"><strong aria-hidden="true">12.1.1.</strong> Attesting</a></li><li class="chapter-item expanded "><a href="../../development/portal/evm/tokenTransfer.html"><strong aria-hidden="true">12.1.2.</strong> Transfer Tokens</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.</strong> Portal JS Client Transfers</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.1.</strong> EVM to Solana Transfer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.2.</strong> Polygon to Oasis with Relayers</div></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> Portal Payloads</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Other Resources</li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> Reference</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/tools.html"><strong aria-hidden="true">14.1.</strong> Tools</a></li><li class="chapter-item expanded "><a href="../../reference/github.html"><strong aria-hidden="true">14.2.</strong> Github &amp; Useful Links</a></li><li class="chapter-item expanded "><a href="../../reference/contracts.html"><strong aria-hidden="true">14.3.</strong> Deployed Contracts</a></li><li class="chapter-item expanded "><a href="../../reference/rpcnodes.html"><strong aria-hidden="true">14.4.</strong> RPC Nodes</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Wormhole xDapp Development Book v0.1.0</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/certusone/xdapp-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="messengersol"><a class="header" href="#messengersol">Messenger.sol</a></h1>
<p>Messenger.sol is an application contract on EVM capable of communicating with the Wormhole core bridge. </p>
<p>Start by hard coding the Wormhole core bridge address, and creating a interfaced link to it. </p>
<pre><code class="language-solidity">//SPDX-License-Identifier: Unlicense
pragma solidity ^0.8.0;

import &quot;./Wormhole/IWormhole.sol&quot;;

contract Messenger {
    string private current_msg;
    address private wormhole_core_bridge_address = address(0xC89Ce4735882C9F0f0FE26686c53074E09B0D550);
    IWormhole core_bridge = IWormhole(wormhole_core_bridge_address);

    // Used to calculate the Sequence for each message sent from this contract    
    uint32 nonce = 0;
    // Chain ID =&gt; Application Contract mapping to ensure we only process messages from contracts we want to.
    mapping(uint16 =&gt; bytes32) _applicationContracts;
    address owner;
    // Track which messages we've already processed so we don't double process messages.
    mapping(bytes32 =&gt; bool) _completedMessages;
}

</code></pre>
<h2 id="constructor"><a class="header" href="#constructor">Constructor</a></h2>
<p>This sets the owner of the contract to the deployer. The owner is used later to register sibling contracts on foreign chains.</p>
<pre><code class="language-solidity">
constructor(){
    owner = msg.sender;
}

</code></pre>
<h2 id="sendmsg"><a class="header" href="#sendmsg">SendMsg</a></h2>
<p>This takes in a bytes payload and calls the Wormhole Core Bridge to publish the bytes as a message. </p>
<p>The <code>publishMessage()</code> function of the core_bridge take three arguements: </p>
<ul>
<li>Nonce: a number to uniquely identify this message, used to make sure that the target chain doesn't double process the same message</li>
<li>Payload: the bytes payload</li>
<li>Confirmations: the number of blocks the guardians should wait before signing this VAA. For low security applications, this number can be low, but if you're on a chain that often reorgs a high number of blocks (like Polygon) you might want to set this number high enough to ensure your transaction from the source chain doesn't get lost after the guardians sign it.</li>
</ul>
<pre><code class="language-solidity">function sendMsg(bytes memory str) public returns (uint64 sequence) {
    sequence = core_bridge.publishMessage(nonce, str, 1);
    nonce = nonce+1;
}
</code></pre>
<h2 id="receiveencodedmsg"><a class="header" href="#receiveencodedmsg">ReceiveEncodedMsg</a></h2>
<p>The receive encoded message takes in a VAA as bytes. Then it calls the Core Bridge to verify the signatures match those of the gaurdians, check that it's from a contract on a foreign chain that we actually want to listen to and that the message hasn't been processed already. If all those checks pass, we can decode the payload (in this case we know it's a string) and set the current_msg for the contract to that payload.</p>
<pre><code class="language-solidity">
function receiveEncodedMsg(bytes memory encodedMsg) public {
    (IWormhole.VM memory vm, bool valid, string memory reason) = core_bridge.parseAndVerifyVM(encodedMsg);
    
    //1. Check Wormhole Guardian Signatures
    //  If the VM is NOT valid, will return the reason it's not valid
    //  If the VM IS valid, reason will be blank
    require(valid, reason);

    //2. Check if the Emitter Chain contract is registered
    require(_applicationContracts[vm.emitterChainId] == vm.emitterAddress, &quot;Invalid Emitter Address!&quot;);

    //3. Check that the message hasn't already been processed
    require(!_completedMessages[vm.hash], &quot;Message already processed&quot;);
    _completedMessages[vm.hash] = true;

    //Do the thing
    current_msg = string(vm.payload);
}


</code></pre>
<h2 id="getcurrentmsg"><a class="header" href="#getcurrentmsg">GetCurrentMsg</a></h2>
<p>A simple method that returns the current stored message.</p>
<pre><code class="language-solidity">
function getCurrentMsg() public view returns (string memory){
    return current_msg;
}

</code></pre>
<h2 id="registerapplicationcontracts"><a class="header" href="#registerapplicationcontracts">RegisterApplicationContracts</a></h2>
<p>It's typically a good idea to register and track the contracts from foreign chains that you're accepting VAAs from, as anyone could deploy a contract and generate a fake VAA that looks like a real VAA you'd want to accept. </p>
<pre><code class="language-solidity">
/**
    Registers it's sibling applications on other chains as the only ones that can send this instance messages
    */
function registerApplicationContracts(uint16 chainId, bytes32 applicationAddr) public {
    require(msg.sender == owner, &quot;Only owner can register new chains!&quot;);
    _applicationContracts[chainId] = applicationAddr;
}

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../projects/evm-messenger/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../projects/evm-messenger/client.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../projects/evm-messenger/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../projects/evm-messenger/client.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
